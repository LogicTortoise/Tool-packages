# THSTrader-skill

æ–°ç‰ˆåŒèŠ±é¡ºæ¨¡æ‹Ÿç‚’è‚¡è‡ªåŠ¨åŒ–äº¤æ˜“å·¥å…·ï¼ˆé€‚é…ç‰ˆæœ¬ 11.46.04ï¼‰

åŸºäº [THSTrader](https://github.com/nladuo/THSTrader) å¤åˆ»ï¼Œé€‚é…æ–°ç‰ˆåŒèŠ±é¡º UIã€‚

## åŠŸèƒ½ç‰¹æ€§

### æ ¸å¿ƒåŠŸèƒ½
- âœ… **è·å–è´¦æˆ·ä½™é¢** - æŸ¥è¯¢æ€»èµ„äº§ã€å¯ç”¨èµ„é‡‘ã€æµ®åŠ¨ç›ˆäºç­‰
- âœ… **è·å–æŒä»“åˆ—è¡¨** - æŸ¥çœ‹å½“å‰æŒæœ‰çš„æ‰€æœ‰è‚¡ç¥¨åŠæ•°é‡
- âœ… **ä¹°å…¥è‚¡ç¥¨** - è‡ªåŠ¨åŒ–ä¹°å…¥æµç¨‹ï¼Œæ”¯æŒä»·æ ¼å’Œæ•°é‡å‚æ•°
- âœ… **å–å‡ºè‚¡ç¥¨** - è‡ªåŠ¨åŒ–å–å‡ºæµç¨‹
- âœ… **è·å–å¯æ’¤å•åˆ—è¡¨** - æŸ¥çœ‹æ‰€æœ‰å¾…æˆäº¤çš„å§”æ‰˜
- âœ… **æ’¤å•** - å–æ¶ˆæŒ‡å®šçš„å§”æ‰˜è®¢å•

### è‡ªé€‰è‚¡ç®¡ç† ğŸ†•
- âœ… **æ·»åŠ è‡ªé€‰è‚¡** - è¾“å…¥æ‹¼éŸ³é¦–å­—æ¯æœç´¢å¹¶æ·»åŠ ï¼ˆå¦‚ "hkws" ä»£è¡¨æµ·åº·å¨è§†ï¼‰
- âœ… **ç§»é™¤è‡ªé€‰è‚¡** - ä»è‡ªé€‰ä¸­ç§»é™¤æŒ‡å®šè‚¡ç¥¨
- âœ… **è·å–è‚¡ç¥¨ä»£ç ** - ä»è‡ªé€‰åŒºæŸ¥è¯¢è‚¡ç¥¨ä»£ç 
- âœ… **ä»è‡ªé€‰åŒºä¹°å…¥** - ç›´æ¥ä½¿ç”¨æ‹¼éŸ³é¦–å­—æ¯ä¹°å…¥ï¼ˆæ— éœ€ä»£ç ï¼‰
- âœ… **ä»è‡ªé€‰åŒºå–å‡º** - ç›´æ¥ä½¿ç”¨æ‹¼éŸ³é¦–å­—æ¯å–å‡ºï¼ˆæ— éœ€ä»£ç ï¼‰

### è¾…åŠ©åŠŸèƒ½
- ğŸ“¸ **è‡ªåŠ¨æˆªå›¾** - æ¯æ¬¡äº¤æ˜“è‡ªåŠ¨ä¿å­˜æˆªå›¾è®°å½•
- ğŸ” **OCR è¯†åˆ«** - ä½¿ç”¨ cnocr è¯†åˆ«æŒä»“å’Œæ’¤å•ä¿¡æ¯ï¼ˆé’ˆå¯¹ä¸­æ–‡ä¼˜åŒ–ï¼‰
- ğŸ›¡ï¸ **äºŒæ¬¡ç¡®è®¤** - ä¹°å…¥/å–å‡ºå‰è‡ªåŠ¨éªŒè¯è®¢å•ä¿¡æ¯
- ğŸ”¤ **æ‹¼éŸ³æœç´¢** - æ”¯æŒæ‹¼éŸ³é¦–å­—æ¯å¿«é€Ÿæœç´¢è‚¡ç¥¨
- ğŸ”Œ **ç¨³å®šè¿æ¥** - ä½¿ç”¨ mobileas å¯å‘çš„è¿æ¥æ¶æ„ï¼Œè§£å†³æ¨¡æ‹Ÿå™¨å…¼å®¹æ€§é—®é¢˜

## ç¯å¢ƒè¦æ±‚

### ç¡¬ä»¶ç¯å¢ƒ
- Android æ¨¡æ‹Ÿå™¨ï¼ˆBlueStacks / é›·ç”µ / å¤œç¥ç­‰ï¼‰
- åˆ†è¾¨ç‡ï¼š720x1280ï¼ˆç«–å±ï¼‰
- DPIï¼š240 æˆ– 320

### è½¯ä»¶ç¯å¢ƒ
- Python 3.8+
- åŒèŠ±é¡º APPï¼ˆç‰ˆæœ¬ 11.46.04ï¼ŒåŒ…åï¼šcom.hexin.plat.androidï¼‰
- ADB å·¥å…·

## å®‰è£…æ­¥éª¤

### 1. å…‹éš†é¡¹ç›®

```bash
cd /Users/Hht/Documents/10.github
git clone <repository-url> THSTrader-skill
cd THSTrader-skill
```

### 2. å®‰è£…ä¾èµ–

```bash
pip install -r requirements.txt
```

### 3. é…ç½®æ¨¡æ‹Ÿå™¨

#### BlueStacks é…ç½®
1. æ‰“å¼€ BlueStacks è®¾ç½®
2. æ˜¾ç¤º â†’ åˆ†è¾¨ç‡ï¼šè‡ªå®šä¹‰ 720x1280
3. æ˜¾ç¤º â†’ DPIï¼š240
4. é‡å¯æ¨¡æ‹Ÿå™¨

#### ADB è¿æ¥
```bash
# è¿æ¥ BlueStacks
adb connect 127.0.0.1:5565

# éªŒè¯è¿æ¥
adb devices
```

### 4. å®‰è£…åŒèŠ±é¡º

ä¸‹è½½å¹¶å®‰è£…åŒèŠ±é¡º APPï¼ˆç‰ˆæœ¬ 11.46.04ï¼‰ï¼š
```bash
adb -s 127.0.0.1:5565 install tonghuashun.apk
```

### 5. é…ç½®åŒèŠ±é¡º
1. å¯åŠ¨åŒèŠ±é¡º APP
2. ç™»å½•è´¦å·
3. è¿›å…¥"æ¨¡æ‹Ÿç‚’è‚¡"åŠŸèƒ½
4. ç¡®ä¿æ¨¡æ‹Ÿç‚’è‚¡å¯ä»¥æ­£å¸¸ä½¿ç”¨

## ä½¿ç”¨æ–¹æ³•

### å‘½ä»¤è¡Œç•Œé¢

```bash
# æŸ¥çœ‹å¸®åŠ©
python trader.py --help

# è·å–è´¦æˆ·ä½™é¢
python trader.py balance

# è·å–æŒä»“åˆ—è¡¨
python trader.py position

# ä¹°å…¥è‚¡ç¥¨ï¼ˆè‚¡ç¥¨ä»£ç ã€æ•°é‡ã€ä»·æ ¼ï¼‰
python trader.py buy --code 002415 --amount 1000 --price 10.0

# å–å‡ºè‚¡ç¥¨
python trader.py sell --code 002415 --amount 500 --price 11.0

# æŸ¥çœ‹å¯æ’¤å•åˆ—è¡¨
python trader.py withdrawals

# æ’¤å•
python trader.py cancel --name æµ·åº·å¨è§† --type ä¹°å…¥ --amount 1000 --price 10.0

# æ·»åŠ è‡ªé€‰è‚¡ï¼ˆä½¿ç”¨æ‹¼éŸ³é¦–å­—æ¯ï¼‰
python trader.py add-favorite --pinyin hkws   # æµ·åº·å¨è§†

# ç§»é™¤è‡ªé€‰è‚¡
python trader.py remove-favorite --pinyin xfetf  # æ¶ˆè´¹ETF

# è·å–è‡ªé€‰è‚¡ä»£ç 
python trader.py get-code --pinyin hkws

# ä»è‡ªé€‰åŒºä¹°å…¥ï¼ˆä½¿ç”¨æ‹¼éŸ³é¦–å­—æ¯ï¼Œæ— éœ€è‚¡ç¥¨ä»£ç ï¼‰
python trader.py buy-favorite --pinyin hkws --amount 1000 --price 31.5

# ä»è‡ªé€‰åŒºå–å‡ºï¼ˆä½¿ç”¨æ‹¼éŸ³é¦–å­—æ¯ï¼Œæ— éœ€è‚¡ç¥¨ä»£ç ï¼‰
python trader.py sell-favorite --pinyin hkws --amount 500 --price 32.0

# æŒ‡å®šè®¾å¤‡
python trader.py balance --device 127.0.0.1:5565

# JSON æ ¼å¼è¾“å‡º
python trader.py balance --json
```

### Python API

```python
from ths import THSTrader

# åˆå§‹åŒ–
trader = THSTrader("127.0.0.1:5565")

# è·å–ä½™é¢
balance = trader.get_balance()
print(balance)
# {'æ€»èµ„äº§': '200,000.00', 'å¯ç”¨': '180,000.00', ...}

# è·å–æŒä»“
positions = trader.get_position()
for pos in positions:
    print(f"{pos['è‚¡ç¥¨åç§°']}: {pos['è‚¡ç¥¨ä½™é¢']}è‚¡")

# ä¹°å…¥è‚¡ç¥¨
result = trader.buy("002415", 1000, 10.0)
if result['success']:
    print(f"ä¹°å…¥æˆåŠŸ: {result['msg']}")

# å–å‡ºè‚¡ç¥¨
result = trader.sell("002415", 500, 11.0)
if result['success']:
    print(f"å–å‡ºæˆåŠŸ: {result['msg']}")

# è·å–å¯æ’¤å•åˆ—è¡¨
withdrawals = trader.get_avail_withdrawals()
for w in withdrawals:
    print(f"{w['è‚¡ç¥¨åç§°']} {w['å§”æ‰˜ç±»å‹']} {w['å§”æ‰˜æ•°é‡']}è‚¡ @{w['å§”æ‰˜ä»·æ ¼']}")

# æ’¤å•
result = trader.withdraw("æµ·åº·å¨è§†", "ä¹°å…¥", 1000, 10.0)
if result['success']:
    print("æ’¤å•æˆåŠŸ")

# æ·»åŠ è‡ªé€‰è‚¡ï¼ˆä½¿ç”¨æ‹¼éŸ³é¦–å­—æ¯ï¼‰
result = trader.add_favorite("hkws")  # æµ·åº·å¨è§†
if result['success']:
    print(f"æ·»åŠ æˆåŠŸï¼Œè‚¡ç¥¨ä»£ç : {result.get('stock_code', 'æœªè·å–')}")

# ç§»é™¤è‡ªé€‰è‚¡
result = trader.remove_favorite("xfetf")  # æ¶ˆè´¹ETF
if result['success']:
    print("ç§»é™¤æˆåŠŸ")

# è·å–è‡ªé€‰è‚¡ä»£ç 
result = trader.get_favorite_code("hkws")
if result['success']:
    print(f"è‚¡ç¥¨ä»£ç : {result['stock_code']}")

# ä»è‡ªé€‰åŒºä¹°å…¥ï¼ˆä½¿ç”¨æ‹¼éŸ³é¦–å­—æ¯ï¼Œæ— éœ€ä»£ç ï¼‰
result = trader.buy_from_favorite("hkws", 1000, 31.5)
if result['success']:
    print(f"ä¹°å…¥æˆåŠŸ: {result['msg']}")

# ä»è‡ªé€‰åŒºå–å‡ºï¼ˆä½¿ç”¨æ‹¼éŸ³é¦–å­—æ¯ï¼Œæ— éœ€ä»£ç ï¼‰
result = trader.sell_from_favorite("hkws", 500, 32.0)
if result['success']:
    print(f"å–å‡ºæˆåŠŸ: {result['msg']}")
```

## é¡¹ç›®ç»“æ„

```
THSTrader-skill/
â”œâ”€â”€ README.md                # é¡¹ç›®æ–‡æ¡£
â”œâ”€â”€ requirements.txt         # Python ä¾èµ–
â”œâ”€â”€ trader.py               # CLI å…¥å£
â”œâ”€â”€ test_all_features.py    # å®Œæ•´åŠŸèƒ½æµ‹è¯•è„šæœ¬
â”œâ”€â”€ install_u2.py           # uiautomator2 å®‰è£…å·¥å…·
â””â”€â”€ ths/                    # æ ¸å¿ƒæ¨¡å—
    â”œâ”€â”€ __init__.py         # æ¨¡å—åˆå§‹åŒ–
    â”œâ”€â”€ config.py           # UI å…ƒç´ é…ç½®
    â”œâ”€â”€ device.py           # Device è¿æ¥ç®¡ç†ç±»
    â””â”€â”€ trader.py           # Trader æ ¸å¿ƒç±»
```

## æŠ€æœ¯å®ç°

### Device è¿æ¥ç®¡ç†æ¶æ„

ä½¿ç”¨ mobileas å¯å‘çš„ Device ç±»è¿›è¡Œè¿æ¥ç®¡ç†ï¼š

```python
class Device:
    def __init__(self, serial):
        # ä½¿ç”¨ u2.connect_usb() æä¾›æ›´ç¨³å®šçš„è¿æ¥
        if serial.startswith('127.0.0.1:'):
            self._device = u2.connect_usb(serial)
        else:
            self._device = u2.connect(serial)

        # è®¾ç½® 7 å¤©è¶…æ—¶ä¿æŒè¿æ¥
        self._device.set_new_command_timeout(604800)
```

**ä¼˜åŠ¿**ï¼š
- âœ… è§£å†³ BlueStacks/æ¨¡æ‹Ÿå™¨çš„ InvalidVersion é—®é¢˜
- âœ… æ›´ç¨³å®šçš„é•¿æ—¶é—´è¿æ¥
- âœ… è‡ªåŠ¨é‡è¯•æœºåˆ¶
- âœ… ç»Ÿä¸€çš„é”™è¯¯å¤„ç†

### UI å…ƒç´ å®šä½æ–¹å¼

1. **Resource ID å®šä½**
   ```python
   self.d(resourceId="com.hexin.plat.android:id/menu_buy_image").click()
   ```

2. **XPath å®šä½**
   ```python
   self.d.xpath('//*[@content-desc="äº¤æ˜“"]/android.widget.ImageView[1]').click()
   ```

3. **åæ ‡å®šä½**ï¼ˆå…œåº•æ–¹æ¡ˆï¼‰
   ```python
   self.d.click(420, 1210)  # ç‚¹å‡»äº¤æ˜“æ ‡ç­¾
   ```

### OCR æ–‡å­—è¯†åˆ«

ä½¿ç”¨ cnocr (ä¸­æ–‡OCR) è¯†åˆ«æŒä»“å’Œæ’¤å•åˆ—è¡¨ï¼š

```python
# æˆªå›¾æŒä»“é¡¹
self.d.xpath('...').screenshot().save("tmp.png")

# è£å‰ªè‚¡ç¥¨åç§°åŒºåŸŸ
Image.open("tmp.png").crop((11, 11, 165, 55)).save("tmp.png")

# OCR è¯†åˆ«ï¼ˆcnocr é’ˆå¯¹ä¸­æ–‡ä¼˜åŒ–ï¼‰
result = self.reader.ocr_for_single_line("tmp.png")
stock_name = ''.join(result)
```

### æ ¸å¿ƒæµç¨‹

#### ä¹°å…¥æµç¨‹
1. å¯¼èˆªåˆ°æ¨¡æ‹Ÿç‚’è‚¡é¡µé¢
2. ç‚¹å‡»"ä¹°å…¥"æŒ‰é’®
3. è¾“å…¥è‚¡ç¥¨ä»£ç ï¼ˆé€šè¿‡ ADB shellï¼‰
4. é€‰æ‹©æœç´¢ç»“æœ
5. è¾“å…¥ä»·æ ¼
6. è¾“å…¥æ•°é‡
7. ç‚¹å‡»"ä¹°å…¥"æŒ‰é’®
8. äºŒæ¬¡ç¡®è®¤ï¼ˆéªŒè¯è‚¡ç¥¨ä»£ç ã€æ•°é‡ã€ä»·æ ¼ï¼‰
9. ç‚¹å‡»"ç¡®è®¤ä¹°å…¥"
10. OCR è¯†åˆ«ç»“æœæ¶ˆæ¯
11. ä¿å­˜æˆªå›¾

## ä¸åŸç‰ˆ THSTrader çš„åŒºåˆ«

| ç‰¹æ€§ | åŸç‰ˆ THSTrader | THSTrader-skill |
|------|---------------|-----------------|
| æ”¯æŒç‰ˆæœ¬ | æ—§ç‰ˆåŒèŠ±é¡º | æ–°ç‰ˆ 11.46.04 |
| ä½™é¢æŸ¥è¯¢ | `totalasset_value` | `capital_cell_value` |
| å¯¼èˆªæ–¹å¼ | XPath | XPath + åæ ‡å…œåº• |
| CLI æ”¯æŒ | âŒ | âœ… |
| JSON è¾“å‡º | âŒ | âœ… |
| æˆªå›¾è®°å½• | éƒ¨åˆ† | å…¨æµç¨‹ |

## æ³¨æ„äº‹é¡¹

1. **åˆ†è¾¨ç‡è¦æ±‚**
   - å¿…é¡»ä½¿ç”¨ 720x1280ï¼ˆç«–å±ï¼‰ï¼Œå¦åˆ™åæ ‡å®šä½ä¼šå¤±è´¥
   - å»ºè®® DPI è®¾ç½®ä¸º 240 æˆ– 320

2. **æ¨¡æ‹Ÿç‚’è‚¡**
   - é»˜è®¤ç”¨äºæ¨¡æ‹Ÿç‚’è‚¡ï¼Œæ‰©å±•åˆ°å®ç›˜éœ€è¦ä¿®æ”¹ä»£ç 

3. **OCR æ€§èƒ½**
   - é¦–æ¬¡åˆå§‹åŒ– cnocr è¾ƒæ…¢ï¼ˆä¸‹è½½æ¨¡å‹ï¼‰
   - æŒä»“å’Œæ’¤å•åˆ—è¡¨æŸ¥è¯¢é€Ÿåº¦å— OCR å½±å“
   - cnocr é’ˆå¯¹ä¸­æ–‡ä¼˜åŒ–ï¼Œè¯†åˆ«å‡†ç¡®ç‡æ›´é«˜

4. **äº¤æ˜“è§„åˆ™**
   - Aè‚¡ T+1 è§„åˆ™ï¼šå½“å¤©ä¹°å…¥çš„è‚¡ç¥¨ï¼Œç¬¬äºŒå¤©æ‰èƒ½å–å‡º
   - ä¹°å…¥æ•°é‡å¿…é¡»æ˜¯ 100 çš„æ•´æ•°å€

5. **é”™è¯¯å¤„ç†**
   - å¦‚é‡åˆ°"æœªå“åº”"å¯¹è¯æ¡†ï¼Œè„šæœ¬ä¼šè‡ªåŠ¨ç‚¹å‡»"ç­‰å¾…"
   - æ‰€æœ‰äº¤æ˜“éƒ½æœ‰æˆªå›¾è®°å½•ï¼Œå¤±è´¥æ—¶æŸ¥çœ‹æˆªå›¾æ’æŸ¥

## å¸¸è§é—®é¢˜

### Q1: è¿æ¥å¤±è´¥

```bash
# é‡å¯ ADB æœåŠ¡
adb kill-server
adb start-server
adb connect 127.0.0.1:5565
```

### Q2: UI å…ƒç´ æ‰¾ä¸åˆ°

æ£€æŸ¥ï¼š
1. åŒèŠ±é¡ºç‰ˆæœ¬æ˜¯å¦ä¸º 11.46.04
2. åˆ†è¾¨ç‡æ˜¯å¦ä¸º 720x1280
3. æ˜¯å¦åœ¨æ¨¡æ‹Ÿç‚’è‚¡é¡µé¢

### Q3: OCR è¯†åˆ«å¤±è´¥

```bash
# é‡æ–°å®‰è£… cnocr
pip uninstall cnocr
pip install cnocr
```

### Q5: uiautomator2 è¿æ¥å¤±è´¥

```bash
# ä½¿ç”¨ install_u2.py é‡æ–°å®‰è£… uiautomator2
python install_u2.py
```

è¿™ä¼šè‡ªåŠ¨ï¼š
- å®‰è£… uiautomator2 APK åˆ°æ¨¡æ‹Ÿå™¨
- ç§»é™¤å¯èƒ½å¯¼è‡´é—®é¢˜çš„ minicap
- ä¿®å¤ç‰ˆæœ¬æ£€æŸ¥é—®é¢˜

### Q4: ä¹°å…¥/å–å‡ºå¤±è´¥

æŸ¥çœ‹æˆªå›¾æ–‡ä»¶ï¼š
- `buy_<è‚¡ç¥¨ä»£ç >_before.png` - ä¹°å…¥å‰æˆªå›¾
- `buy_<è‚¡ç¥¨ä»£ç >_confirm.png` - ç¡®è®¤å¯¹è¯æ¡†
- `buy_<è‚¡ç¥¨ä»£ç >_after.png` - ä¹°å…¥åæˆªå›¾

## åŠŸèƒ½æµ‹è¯•

è¿è¡Œå®Œæ•´åŠŸèƒ½æµ‹è¯•ï¼š

```bash
python test_all_features.py
```

æµ‹è¯•åŒ…æ‹¬ï¼š
- âœ… è®¾å¤‡è¿æ¥
- âœ… è·å–è´¦æˆ·ä½™é¢
- âœ… è·å–æŒä»“åˆ—è¡¨
- âœ… è·å–å¯æ’¤å•åˆ—è¡¨
- âœ… ä¹°å…¥/å–å‡ºåŠŸèƒ½
- âœ… è‡ªé€‰è‚¡æ“ä½œ

æµ‹è¯•æŠ¥å‘Šä¼šæ˜¾ç¤ºæ¯é¡¹åŠŸèƒ½çš„é€šè¿‡/å¤±è´¥çŠ¶æ€ã€‚

## ç¤ºä¾‹è„šæœ¬

### æ‰¹é‡ä¹°å…¥

```python
from ths import THSTrader

trader = THSTrader()

# æ‰¹é‡ä¹°å…¥
stocks = [
    ("002415", 1000, 10.0),   # æµ·åº·å¨è§†
    ("300033", 1000, 349.0),  # åŒèŠ±é¡º
]

for code, amount, price in stocks:
    result = trader.buy(code, amount, price)
    print(f"{code}: {result['msg']}")
```

### è‡ªåŠ¨æ­¢ç›ˆæ­¢æŸ

```python
from ths import THSTrader

trader = THSTrader()

# è·å–æŒä»“
positions = trader.get_position()

for pos in positions:
    # è¿™é‡Œå¯ä»¥æ ¹æ®æŒä»“æƒ…å†µè‡ªåŠ¨å–å‡º
    pass
```

## å¼€å‘è®¡åˆ’

- [ ] æ”¯æŒå®ç›˜äº¤æ˜“
- [ ] æ”¯æŒæ›´å¤šåŒèŠ±é¡ºç‰ˆæœ¬
- [ ] æ·»åŠ ç­–ç•¥å›æµ‹åŠŸèƒ½
- [ ] ä¼˜åŒ– OCR è¯†åˆ«é€Ÿåº¦
- [ ] Web UI ç•Œé¢

## è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼

## è®¸å¯è¯

MIT License

## è‡´è°¢

- åŸç‰ˆ [THSTrader](https://github.com/nladuo/THSTrader) ä½œè€…
- [mobileas](https://github.com/LmeSzinc/AzurLaneAutoScript) - Device æ¶æ„è®¾è®¡çµæ„Ÿ
- [uiautomator2](https://github.com/openatx/uiautomator2) é¡¹ç›®
- [cnocr](https://github.com/breezedeus/cnocr) - ä¸­æ–‡ OCR è¯†åˆ«

## å…è´£å£°æ˜

æœ¬é¡¹ç›®ä»…ä¾›å­¦ä¹ äº¤æµä½¿ç”¨ï¼Œä¸æ„æˆä»»ä½•æŠ•èµ„å»ºè®®ã€‚ä½¿ç”¨æœ¬é¡¹ç›®è¿›è¡Œå®ç›˜äº¤æ˜“çš„é£é™©ç”±ä½¿ç”¨è€…è‡ªè¡Œæ‰¿æ‹…ã€‚
