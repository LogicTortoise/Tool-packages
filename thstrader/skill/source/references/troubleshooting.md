# 故障排除指南

## 常见问题

### Q1: ADB 连接失败

**症状**: `error: failed to connect to 127.0.0.1:5565`

**解决方案**:
```bash
# 重启 ADB 服务
adb kill-server
adb start-server
adb connect 127.0.0.1:5565
```

如果仍然失败，检查:
1. BlueStacks 是否正在运行
2. 端口 5565 是否被占用
3. 防火墙是否阻止了连接

### Q2: UI 元素找不到

**症状**: `UiObjectNotFoundError` 或元素定位失败

**检查清单**:
1. **同花顺版本**: 必须是 11.46.04
2. **分辨率**: 必须是 720x1280（竖屏）
3. **DPI**: 建议 240 或 320
4. **页面状态**: 确保在模拟炒股页面

**验证分辨率**:
```bash
adb -s 127.0.0.1:5565 shell wm size
# 应输出: Physical size: 720x1280
```

### Q3: OCR 识别失败

**症状**: 持仓列表或撤单列表查询失败

**解决方案**:
```bash
# 重新安装 easyocr
pip uninstall easyocr
pip install easyocr
```

**注意**: 首次使用 EasyOCR 会下载模型文件，可能需要几分钟。

### Q4: 买入/卖出操作失败

**排查步骤**:

1. **查看截图文件** (保存在当前目录):
   - `buy_<股票代码>_before.png` - 买入前截图
   - `buy_<股票代码>_confirm.png` - 确认对话框
   - `buy_<股票代码>_after.png` - 买入后截图

2. **检查交易规则**:
   - A股 T+1 规则: 当天买入的股票，第二天才能卖出
   - 买入数量必须是 100 的整数倍
   - 确保账户有足够资金

3. **检查输入参数**:
   - 股票代码格式是否正确 (6位数字)
   - 价格是否在合理范围
   - 数量是否符合交易规则

### Q5: 撤单失败

**症状**: 撤单操作无响应或失败

**可能原因**:
1. 委托已成交 - 无法撤销已成交的订单
2. 委托已撤销 - 重复撤销
3. OCR 识别错误 - 股票名称/价格/数量不匹配

**解决方案**:
1. 先运行 `python trader.py withdrawals` 查看当前可撤单列表
2. 确认撤单参数与列表中的信息完全一致
3. 检查截图确认 OCR 识别是否准确

### Q6: "应用未响应"对话框

**症状**: 同花顺 APP 弹出"未响应"对话框

**自动处理**: 脚本会自动点击"等待"按钮

**手动处理**: 如果自动处理失败，手动点击"等待"

### Q7: 模拟炒股账户找不到

**症状**: 无法进入模拟炒股页面

**解决方案**:
1. 打开同花顺 APP
2. 手动进入"模拟炒股"功能
3. 确保模拟炒股账户已创建并可用
4. 重新运行脚本

## 调试技巧

### 启用详细日志

修改脚本中的日志级别:
```python
import logging
logging.basicConfig(level=logging.DEBUG)
```

### 手动检查 UI 元素

使用 uiautomator2 的 weditor 工具:
```bash
pip install weditor
python -m weditor
```

在浏览器中打开 http://localhost:17310 查看 UI 元素树。

### 保存调试截图

在关键步骤添加截图:
```python
self.d.screenshot("debug_step.png")
```

## 错误代码参考

| 错误代码 | 说明 | 解决方案 |
|---------|------|---------|
| `ConnectionError` | ADB 连接失败 | 重启 ADB 服务 |
| `UiObjectNotFoundError` | UI 元素未找到 | 检查版本和分辨率 |
| `ValueError` | 参数错误 | 检查输入参数格式 |
| `TimeoutError` | 操作超时 | 检查网络和 APP 状态 |

## 获取帮助

如果以上方法都无法解决问题:

1. 查看完整的错误堆栈
2. 检查截图文件
3. 确认环境配置符合要求
4. 提供详细的错误信息和环境信息
